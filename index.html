<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bart's Lobotomy - Beta 0.4</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', Courier, monospace; }
        canvas { display: block; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; color: #FFD90F;
        }
        #ui {
            position: absolute; top: 20px; width: 100%; text-align: center; color: #FFD90F; 
            font-size: 24px; pointer-events: none; z-index: 5; text-shadow: 2px 2px #f00;
        }
        #shop-menu {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #100; z-index: 110; flex-direction: column; justify-content: center; align-items: center; color: #FFD90F;
            overflow-y: auto; padding: 20px;
        }
        .skin-grid { display: flex; flex-wrap: wrap; justify-content: center; max-width: 900px; }
        .skin-card {
            border: 2px solid #FFD90F; padding: 10px; margin: 5px; width: 220px; text-align: center; background: #200;
        }
        #qte {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 180px; color: #fff; display: none; font-weight: bold; z-index: 10;
            text-shadow: 0 0 50px #ff0000;
        }
        button {
            padding: 10px 20px; font-size: 18px; background: #FFD90F; border: none;
            cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold;
            box-shadow: 4px 4px 0 #ff0000; margin: 5px;
        }
        button:hover { background: #fff; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="margin:0;">BART'S LOBOTOMY</h1>
        <h3 style="margin:5px;">(Beta 0.4 - UPGRADES & MULTIPLIERS)</h3>
        <h2 style="margin:0;">A Game By Max And Aiden </h2>
        <h3 id="wallet-display" style="color: #0f0;">TOTAL BRAINS: 0</h3>
        <div style="display:flex;">
            <button onclick="startGame()">ENTER VOID</button>
            <button onclick="toggleShop(true)">SURGERY LAB</button>
        </div>
    </div>

    <div id="shop-menu">
        <h1>SURGERY LAB</h1>
        <h2 style="color:#0f0">BRAINS: <span id="shop-wallet">0</span></h2>
        <h3>SKINS (Click to Equip/Buy)</h3>
        <div class="skin-grid" id="skin-container"></div>
        <h3>UPGRADES</h3>
        <div class="skin-grid">
            <div class="skin-card">
                <h3>SCALPEL SPEED</h3>
                <p id="upg-speed-cost">Cost: 500</p>
                <button onclick="buyUpgrade('bulletSpeed', 500)">UPGRADE</button>
            </div>
        </div>
        <button onclick="toggleShop(false)" style="margin-top:20px;">BACK</button>
    </div>

    <div id="ui">SCORE: 0 | RUN BRAINS: 0</div>
    <div id="qte">!</div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

<script type="module">
import * as THREE from 'three';

// --- DATA ---
let totalBrains = parseInt(localStorage.getItem('total_brains')) || 0;
let unlockedSkins = JSON.parse(localStorage.getItem('unlocked_skins')) || ['default'];
let activeSkin = localStorage.getItem('active_skin') || 'default';
let bulletLvl = parseInt(localStorage.getItem('upg_bullet')) || 1;

const SKINS = [
    { id: 'default', name: 'DEFAULT', cost: 0, mult: 1, color: 0xFFD90F, board: 0x32CD32 },
    { id: 'gold', name: 'GOLDEN', cost: 200, mult: 1.5, color: 0xFFFF00, board: 0xFFAA00 },
    { id: 'flesh', name: 'FLESH', cost: 600, mult: 2, color: 0xFF4444, board: 0x550000 },
    { id: 'nuclear', name: 'NUCLEAR', cost: 1000, mult: 2.5, color: 0x39FF14, board: 0x004400, emissive: 0x39FF14 },
    { id: 'void', name: 'VOID', cost: 2500, mult: 3.5, color: 0x00FFFF, board: 0xFFFFFF, wire: true },
    { id: 'revenge', name: 'REVENGE', cost: 5000, mult: 5, color: 0xFFFFFF, board: 0xFF0000, emissive: 0xFF0000 }
];

const currentSData = SKINS.find(s => s.id === activeSkin) || SKINS[0];
const MULTIPLIER = currentSData.mult;

function saveGameData() {
    localStorage.setItem('total_brains', totalBrains);
    localStorage.setItem('unlocked_skins', JSON.stringify(unlockedSkins));
    localStorage.setItem('active_skin', activeSkin);
    localStorage.setItem('upg_bullet', bulletLvl);
}

// --- SHOP ---
window.toggleShop = (show) => {
    document.getElementById('shop-menu').style.display = show ? 'flex' : 'none';
    document.getElementById('shop-wallet').innerText = totalBrains;
    if(show) renderShop();
};

function renderShop() {
    const container = document.getElementById('skin-container');
    container.innerHTML = SKINS.map(s => {
        const isUnlocked = unlockedSkins.includes(s.id);
        const isActive = activeSkin === s.id;
        return `
            <div class="skin-card">
                <h3>${s.name}</h3>
                <p style="color:#0f0">Payout: x${s.mult}</p>
                <p>${isUnlocked ? 'OWNED' : 'COST: ' + s.cost}</p>
                <button onclick="${isUnlocked ? `window.setSkin('${s.id}')` : `window.buySkin('${s.id}', ${s.cost})`}">
                    ${isActive ? 'EQUIPPED' : (isUnlocked ? 'EQUIP' : 'BUY')}
                </button>
            </div>
        `;
    }).join('');
    document.getElementById('upg-speed-cost').innerText = `Level ${bulletLvl} (Cost: ${500 * bulletLvl})`;
}

window.buySkin = (id, cost) => {
    if (totalBrains >= cost) {
        totalBrains -= cost;
        unlockedSkins.push(id);
        activeSkin = id;
        saveGameData();
        location.reload();
    } else alert("NOT ENOUGH BRAINS!");
};

window.setSkin = (id) => { activeSkin = id; saveGameData(); location.reload(); };

window.buyUpgrade = (type, baseCost) => {
    let cost = baseCost * bulletLvl;
    if (totalBrains >= cost) {
        totalBrains -= cost;
        bulletLvl++;
        saveGameData();
        renderShop();
    } else alert("NOT ENOUGH BRAINS!");
};

// --- CORE GAME ---
let gameActive = false, score = 0, brainsThisRun = 0, speed = 0.4, velocity = 0, gravity = -0.015;
let qteActive = false, currentQTEKey = '';
const obstacles = [], bullets = [];

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const sun = new THREE.PointLight(0xffffff, 100, 100);
sun.position.set(0, 0, 10);
scene.add(sun, new THREE.AmbientLight(0x404040));

const bartMat = new THREE.MeshStandardMaterial({
    color: currentSData.color, 
    wireframe: currentSData.wire || false,
    emissive: currentSData.emissive || 0x000000,
    emissiveIntensity: 1
});

const bart = new THREE.Group();
bart.add(new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 1), bartMat));
bart.add(new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.1, 0.8), new THREE.MeshStandardMaterial({color: currentSData.board})));
bart.position.x = -5;
scene.add(bart);

function playScream() {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(600, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(20, ctx.currentTime + 1);
    gain.gain.setValueAtTime(1.5, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 1);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(); osc.stop(ctx.currentTime + 1);
}

window.startGame = () => {
    document.getElementById('overlay').style.display = 'none';
    gameActive = true;
    animate();
};

function triggerQTE() {
    if (qteActive || !gameActive) return;
    qteActive = true;
    currentQTEKey = ['W','A','S','D','X'][Math.floor(Math.random()*5)];
    const el = document.getElementById('qte');
    el.innerText = currentQTEKey;
    el.style.display = 'block';
    setTimeout(() => { if(qteActive) endGame(); }, 800);
}

window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') gravity *= -1;
    if (qteActive && e.key.toUpperCase() === currentQTEKey) {
        qteActive = false;
        document.getElementById('qte').style.display = 'none';
        score += 200;
        brainsThisRun += Math.floor(60 * MULTIPLIER);
    }
});

window.addEventListener('mousedown', () => {
    if (!gameActive) return;
    const b = new THREE.Mesh(new THREE.SphereGeometry(0.3), new THREE.MeshBasicMaterial({color: 0x00ffff}));
    b.position.copy(bart.position);
    scene.add(b);
    bullets.push(b);
});

function animate() {
    if (!gameActive) return;
    requestAnimationFrame(animate);

    if (Math.random() < 0.007) triggerQTE();
    
    // CAMERA SPIN instead of FLASH
    if (Math.random() < 0.02) {
        camera.rotation.z = (Math.random() - 0.5) * 0.8; 
    } else {
        camera.rotation.z *= 0.9; // Return to level
    }

    velocity += gravity;
    bart.position.y += velocity;
    bart.position.y = Math.max(-4.5, Math.min(4.5, bart.position.y));

    bullets.forEach((b, bi) => {
        b.position.x += 0.8 + (bulletLvl * 0.1); // Bullet Speed Upgrade
        obstacles.forEach((o, oi) => {
            if (b.position.distanceTo(o.position) < 2) {
                scene.remove(o, b);
                obstacles.splice(oi, 1);
                bullets.splice(bi, 1);
                brainsThisRun += Math.floor(25 * MULTIPLIER);
            }
        });
    });

    obstacles.forEach((o, i) => {
        o.position.x -= speed;
        if (bart.position.distanceTo(o.position) < 1.6) endGame();
        if (o.position.x < -20) { 
            scene.remove(o); 
            obstacles.splice(i, 1); 
            score += 10; 
            brainsThisRun += Math.floor(10 * MULTIPLIER);
        }
    });

    if (Math.random() < 0.045) {
        const obs = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 0), new THREE.MeshStandardMaterial({color: 0x882222}));
        obs.position.set(25, (Math.random() * 8) - 4, 0);
        scene.add(obs);
        obstacles.push(obs);
    }

    document.getElementById('ui').innerText = `SCORE: ${score} | RUN BRAINS: ${brainsThisRun} (x${MULTIPLIER})`;
    renderer.render(scene, camera);
}

function endGame() {
    gameActive = false;
    document.getElementById('qte').style.display = 'none';
    playScream();
    totalBrains += brainsThisRun;
    saveGameData();

    const homer = new THREE.Mesh(new THREE.IcosahedronGeometry(6, 1), new THREE.MeshBasicMaterial({color: 0xFFD90F, wireframe: true}));
    homer.position.set(0, 0, 5);
    scene.add(homer);

    let z = 5;
    const scare = setInterval(() => {
        z += 1.8;
        homer.position.z = z;
        camera.rotation.z += 0.2; // Final death spin
        if (z > 22) {
            clearInterval(scare);
            location.reload();
        }
        renderer.render(scene, camera);
    }, 16);
}

document.getElementById('wallet-display').innerText = `TOTAL BRAINS: ${totalBrains}`;
camera.position.z = 12;
</script>
</body>
</html>
